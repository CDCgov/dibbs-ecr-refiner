name: Build and push Refiner Docker images to GHCR and AWS ECR

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch or tag) to build from"
        required: false
        default: main
      version_tag:
        description: "Optional Docker tag to use instead of branch name (`1.2.3`)"
        required: false
      create_release_notes:
        description: "Create draft release notes for this build. Must also provide version_tag."
        type: boolean
        required: false
        default: false

permissions:
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AIMS dev AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          aws-access-key-id: ${{ secrets.AIMS_DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AIMS_DEV_AWS_SECRET_ACCESS_KEY }}

      - name: Login to AIMS dev ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Make repo owner lowercase
        id: repo
        run: |
          echo "owner=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Determine Docker tags
        id: vars
        run: |
          # Get the branch/ref and version tag
          REF_NAME="${{ github.event.inputs.ref || github.ref_name }}"
          VERSION_TAG="${{ github.event.inputs.version_tag }}"
          ECR_REGISTRY="${{ steps.ecr.outputs.registry }}"

          # Sanitize ref so it's a valid image tag
          if [ -z "$VERSION_TAG" ]; then
            TAG=$(echo "$REF_NAME" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
          else
            TAG="$VERSION_TAG"
          fi

          # GHCR URLs
          GHCR_APP="ghcr.io/${{ steps.repo.outputs.owner }}/dibbs-ecr-refiner/refiner"
          GHCR_LAMBDA="ghcr.io/${{ steps.repo.outputs.owner }}/dibbs-ecr-refiner/lambda"
          GHCR_OPS="ghcr.io/${{ steps.repo.outputs.owner }}/dibbs-ecr-refiner/ops"

          # ECR URLs
          ECR_APP="$ECR_REGISTRY/dibbs-dev-refiner/refiner"
          ECR_LAMBDA="$ECR_REGISTRY/dibbs-dev-refiner/lambda"
          ECR_OPS="$ECR_REGISTRY/dibbs-dev-refiner/ops"

          # If building `main`, include a `latest` tag
          if [ "$REF_NAME" = "main" ]; then
            echo "app_tags=$GHCR_APP:$TAG,$GHCR_APP:latest,$ECR_APP:$TAG,$ECR_APP:latest" >> $GITHUB_OUTPUT
            echo "lambda_tags=$GHCR_LAMBDA:$TAG,$GHCR_LAMBDA:latest,$ECR_LAMBDA:$TAG,$ECR_LAMBDA:latest" >> $GITHUB_OUTPUT
            echo "ops_tags=$GHCR_OPS:$TAG,$GHCR_OPS:latest,$ECR_OPS:$TAG,$ECR_OPS:latest" >> $GITHUB_OUTPUT
          else
            echo "app_tags=$GHCR_APP:$TAG,$ECR_APP:$TAG" >> $GITHUB_OUTPUT
            echo "lambda_tags=$GHCR_LAMBDA:$TAG,$ECR_LAMBDA:$TAG" >> $GITHUB_OUTPUT
            echo "ops_tags=$GHCR_OPS:$TAG,$ECR_OPS:$TAG" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Refiner app image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.app
          push: true
          tags: ${{ steps.vars.outputs.app_tags }}
          build-args: |
            VITE_GIT_HASH=${{ github.sha }}
            VITE_GIT_BRANCH=${{ github.ref_name }}
            VERSION=${{ steps.vars.outputs.version_tag }}

      - name: Build and push Refiner Lambda image
        uses: docker/build-push-action@v6
        with:
          context: .
          provenance: false
          file: Dockerfile.lambda
          push: true
          platforms: linux/amd64
          tags: ${{ steps.vars.outputs.lambda_tags }}
          build-args: |
            VERSION=${{ steps.vars.outputs.version_tag }}

      - name: Build and push Refiner Ops image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.ops
          push: true
          tags: ${{ steps.vars.outputs.ops_tags }}
          build-args: |
            VERSION=${{ steps.vars.outputs.version_tag }}

      - name: Create draft GitHub release notes
        if: ${{ github.event.inputs.create_release_notes == 'true' && (github.event.inputs.version_tag != '') }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.version_tag }}
          name: ${{ steps.vars.outputs.version_tag }}
          draft: true
          prerelease: false
          generate_release_notes: true
