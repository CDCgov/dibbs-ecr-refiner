name: Build and push Refiner Docker images to GHCR and AWS ECR

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch or tag) to build from"
        required: false
        default: main
      version_tag:
        description: "Optional Docker tag to use instead of branch name (`1.2.3`)"
        required: false
      create_release_notes:
        description: "Create draft release notes for this build. Must also provide version_tag."
        type: boolean
        required: false
        default: false
      push_ghcr:
        description: "Push images to GitHub Container Registry (GHCR)"
        type: boolean
        default: true
      push_ecr:
        description: "Push images to AWS ECR"
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  build-and-push:
    env:
      PUSH_GHCR: ${{ github.event_name == 'push' || github.event.inputs.push_ghcr }}
      PUSH_ECR: ${{ github.event_name == 'push' || github.event.inputs.push_ecr }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AIMS dev AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          aws-access-key-id: ${{ secrets.AIMS_DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AIMS_DEV_AWS_SECRET_ACCESS_KEY }}

      - name: Login to AIMS dev ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Make repo owner lowercase
        id: repo
        run: |
          echo "owner=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Determine Docker tags
        id: vars
        run: |
          # Get the branch/ref and version tag
          REF_NAME="${{ github.event.inputs.ref || github.ref_name }}"
          VERSION_TAG="${{ github.event.inputs.version_tag }}"
          ECR_REGISTRY="${{ steps.ecr.outputs.registry }}"

          # Sanitize ref so it's a valid image tag
          if [ -z "$VERSION_TAG" ]; then
            TAG=$(echo "$REF_NAME" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
          else
            TAG="$VERSION_TAG"
          fi

          # Define image base URLs
          declare -A BASES=(
            [APP]="refiner"
            [LAMBDA]="lambda"
            [OPS]="ops"
          )

          for IMAGE in APP LAMBDA OPS; do
            TAGS=()

            # GHCR
            if [ "$PUSH_GHCR" = "true" ]; then
              TAGS+=("ghcr.io/${{ steps.repo.outputs.owner }}/dibbs-ecr-refiner/${BASES[$IMAGE]}:$TAG")
            fi

            # ECR
            if [ "$PUSH_ECR" = "true" ]; then
              TAGS+=("$ECR_REGISTRY/dibbs-dev-refiner/${BASES[$IMAGE]}:$TAG")
            fi

            # Add 'latest' if on main
            if [ "$REF_NAME" = "main" ]; then
              [ "$PUSH_GHCR" = "true" ] && TAGS+=("ghcr.io/${{ steps.repo.outputs.owner }}/dibbs-ecr-refiner/${BASES[$IMAGE]}:latest")
              [ "$PUSH_ECR" = "true" ] && TAGS+=("$ECR_REGISTRY/dibbs-dev-refiner/${BASES[$IMAGE]}:latest")
            fi

            # Output as comma-separated string
            echo "${IMAGE,,}_tags=$(IFS=, ; echo "${TAGS[*]}")" >> $GITHUB_OUTPUT
          done

      - name: Debug Docker tags
        run: |
          echo "APP_TAGS: ${{ steps.vars.outputs.app_tags }}"
          echo "LAMBDA_TAGS: ${{ steps.vars.outputs.lambda_tags }}"
          echo "OPS_TAGS: ${{ steps.vars.outputs.ops_tags }}"

      - name: Create and push Git tag for release
        if: ${{ github.event.inputs.create_release_notes == 'true' && (github.event.inputs.version_tag != '') }}
        run: |
          GIT_TAG="${{ github.event.inputs.version_tag }}"
          if git rev-parse "$GIT_TAG" >/dev/null 2>&1; then
            echo "Tag $GIT_TAG already exists, skipping"
          else
            git tag -a "$GIT_TAG" -m "Release $GIT_TAG"
            git push origin "$GIT_TAG"
          fi

      - name: Build and push Refiner app image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.app
          push: true
          tags: ${{ steps.vars.outputs.app_tags }}
          build-args: |
            VITE_GIT_HASH=${{ github.sha }}
            VITE_GIT_BRANCH=${{ github.event.inputs.ref || github.ref_name }}
            VERSION=${{ github.event.inputs.version_tag }}

      - name: Build and push Refiner Lambda image
        uses: docker/build-push-action@v6
        with:
          context: .
          provenance: false
          file: Dockerfile.lambda
          push: true
          platforms: linux/amd64
          tags: ${{ steps.vars.outputs.lambda_tags }}
          build-args: |
            VERSION=${{ github.event.inputs.version_tag }}

      - name: Build and push Refiner Ops image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.ops
          push: true
          tags: ${{ steps.vars.outputs.ops_tags }}
          build-args: |
            VERSION=${{ github.event.inputs.version_tag }}

      - name: Create draft GitHub release notes
        if: ${{ github.event.inputs.create_release_notes == 'true' && (github.event.inputs.version_tag != '') }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version_tag }}
          name: ${{ github.event.inputs.version_tag }}
          draft: true
          prerelease: false
          generate_release_notes: true
