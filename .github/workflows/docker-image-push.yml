name: Build and push Refiner Docker images to GHCR and AWS ECR

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch or tag) to build from"
        required: false
        default: main
      version_tag:
        description: "Optional Docker tag to use instead of branch name (`1.2.3`)"
        required: false
      push_ghcr:
        description: "Push images to GitHub Container Registry (GHCR)"
        type: boolean
        default: true
      push_ecr:
        description: "Push images to AWS ECR"
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  build-and-push:
    env:
      PUSH_GHCR: ${{ github.event_name == 'push' || github.event.inputs.push_ghcr }}
      PUSH_ECR: ${{ github.event_name == 'push' || github.event.inputs.push_ecr }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AIMS dev AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          aws-access-key-id: ${{ secrets.AIMS_DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AIMS_DEV_AWS_SECRET_ACCESS_KEY }}

      - name: Login to AIMS dev ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Make repo owner lowercase
        id: repo
        run: |
          echo "owner=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Determine Docker tags
        id: vars
        run: |
          # Get the branch/ref and version tag
          REF_NAME="${{ github.event.inputs.ref || github.ref_name }}"
          VERSION_TAG="${{ github.event.inputs.version_tag }}"
          ECR_REGISTRY="${{ steps.ecr.outputs.registry }}"

          # Sanitize ref so it's a valid image tag
          if [ -z "$VERSION_TAG" ]; then
            TAG=$(echo "$REF_NAME" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
          else
            TAG="$VERSION_TAG"
          fi

          # GHCR URLs
          GHCR_APP="ghcr.io/${{ steps.repo.outputs.owner }}/dibbs-ecr-refiner/refiner"
          GHCR_LAMBDA="ghcr.io/${{ steps.repo.outputs.owner }}/dibbs-ecr-refiner/lambda"
          GHCR_OPS="ghcr.io/${{ steps.repo.outputs.owner }}/dibbs-ecr-refiner/ops"

          # ECR URLs
          ECR_APP="$ECR_REGISTRY/dibbs-dev-refiner/refiner"
          ECR_LAMBDA="$ECR_REGISTRY/dibbs-dev-refiner/lambda"
          ECR_OPS="$ECR_REGISTRY/dibbs-dev-refiner/ops"

          # If building `main`, include a `latest` tag
          if [ "$REF_NAME" = "main" ]; then

            # Tags to push to GHCR
            echo "ghcr_app_tags=$GHCR_APP:$TAG,$GHCR_APP:latest" >> $GITHUB_OUTPUT
            echo "ghcr_lambda_tags=$GHCR_LAMBDA:$TAG,$GHCR_LAMBDA:latest" >> $GITHUB_OUTPUT
            echo "ghcr_ops_tags=$GHCR_OPS:$TAG,$GHCR_OPS:latest" >> $GITHUB_OUTPUT

            # Tags to push to AWS ECR
            echo "ecr_app_tags=$ECR_APP:$TAG,$ECR_APP:latest" >> $GITHUB_OUTPUT
            echo "ecr_lambda_tags=$ECR_LAMBDA:$TAG,$ECR_LAMBDA:latest" >> $GITHUB_OUTPUT
            echo "ecr_ops_tags=$ECR_OPS:$TAG,$ECR_OPS:latest" >> $GITHUB_OUTPUT

          else
            # Tags to push to GHCR
            echo "ghcr_app_tags=$GHCR_APP:$TAG" >> $GITHUB_OUTPUT
            echo "ghcr_lambda_tags=$GHCR_LAMBDA:$TAG" >> $GITHUB_OUTPUT
            echo "ghcr_ops_tags=$GHCR_OPS:$TAG" >> $GITHUB_OUTPUT

            # Tags to push to AWS ECR
            echo "ecr_app_tags=$ECR_APP:$TAG" >> $GITHUB_OUTPUT
            echo "ecr_lambda_tags=$ECR_LAMBDA:$TAG" >> $GITHUB_OUTPUT
            echo "ecr_ops_tags=$ECR_OPS:$TAG" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Refiner app image (GHCR)
        uses: docker/build-push-action@v6
        if: env.PUSH_GHCR == 'true'
        with:
          context: .
          file: Dockerfile.app
          push: true
          tags: ${{ steps.vars.outputs.ghcr_app_tags }}
          build-args: |
            VITE_GIT_HASH=${{ github.sha }}
            VITE_GIT_BRANCH=${{ github.event.inputs.ref || github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Refiner Lambda image (GHCR)
        uses: docker/build-push-action@v6
        if: env.PUSH_GHCR == 'true'
        with:
          context: .
          provenance: false
          file: Dockerfile.lambda
          push: true
          platforms: linux/amd64
          tags: ${{ steps.vars.outputs.ghcr_lambda_tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Refiner Ops image (GHCR)
        uses: docker/build-push-action@v6
        if: env.PUSH_GHCR == 'true'
        with:
          context: .
          file: Dockerfile.ops
          push: true
          tags: ${{ steps.vars.outputs.ghcr_ops_tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Refiner app image (AWS ECR)
        uses: docker/build-push-action@v6
        if: env.PUSH_ECR == 'true'
        with:
          context: .
          file: Dockerfile.app
          push: true
          tags: ${{ steps.vars.outputs.ecr_app_tags }}
          build-args: |
            VITE_GIT_HASH=${{ github.sha }}
            VITE_GIT_BRANCH=${{ github.event.inputs.ref || github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Refiner Lambda image (AWS ECR)
        uses: docker/build-push-action@v6
        if: env.PUSH_ECR == 'true'
        with:
          context: .
          provenance: false
          file: Dockerfile.lambda
          push: true
          platforms: linux/amd64
          tags: ${{ steps.vars.outputs.ecr_lambda_tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Refiner Ops image (AWS ECR)
        uses: docker/build-push-action@v6
        if: env.PUSH_ECR == 'true'
        with:
          context: .
          file: Dockerfile.ops
          push: true
          tags: ${{ steps.vars.outputs.ecr_ops_tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
